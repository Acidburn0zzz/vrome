<html>
<head>
<script typw='text/javascript'>
var closed_tabs = [];
var now_tab;
var last_selected_tab;

function changeStatus(tab){
  if(!tab.id) return;
  var port = chrome.tabs.connect(tab.id, {});
  var disable_sites = (localStorage.disableSites || '').split(' ');

  for(var i in disable_sites){
    if(disable_sites[i]){
      if(new RegExp(disable_sites[i],'i').test(tab.url)){
        var disable = true;
        break;
      }
    }
  }

  var currentKeys = (localStorage.currentKeys || '').split(' ');
  var times = Number(localStorage.times || 0);

  console.log("Disable Sites: " + disable_sites.join(', ') + " Url: " + tab.url + " Disabled:" + disable + " currentKeys:" + currentKeys + " times:" + times);
  port.postMessage({action : "changeStatus", disable : !!disable,currentKeys : currentKeys, times : times});
}

chrome.tabs.getSelected(null, function(tab) {
  last_selected_tab = now_tab || tab;
  now_tab  = tab;
  changeStatus(tab);
});

chrome.tabs.onSelectionChanged.addListener(function(tabId) {
  chrome.tabs.get(tabId, function(tab) {
    last_selected_tab = now_tab || tab;
    now_tab = tab;
    changeStatus(tab);
  });
});

chrome.tabs.onUpdated.addListener(function(tabId) {
  chrome.tabs.get(tabId, function(tab) {
    if (now_tab && now_tab.id == tab.id) {
      last_selected_tab = tab;
      now_tab = tab;
    }
    changeStatus(tab);
  });
});

chrome.tabs.onRemoved.addListener(function(tabId) {
  if(now_tab) {
    closed_tabs.push(now_tab);
  };
}); 

chrome.extension.onConnect.addListener(function(port, name) {
  port.onMessage.addListener(function(msg) {
    var tab = port.tab;
    switch(msg.action){
    case "enable":
      chrome.browserAction.setIcon({path: 'icons/logo.png'});
      chrome.browserAction.setTitle({title:"Vimlike (enabled)"});
      break;
    case "disable":
      chrome.browserAction.setIcon({path: 'icons/logo-disable.png'});
      chrome.browserAction.setTitle({title:"Vimlike (disabled)"});
      break;

    // Tab
    case "closeTab":
      chrome.tabs.remove(tab.id);
      break;
    case "reopenTab":
      if (closed_tabs.length > 0) {
        var last_closed_tab = closed_tabs[closed_tabs.length - 1]
        closed_tabs.pop();
        chrome.tabs.create({url: last_closed_tab.url, index: last_closed_tab.index});
      }
      break;
    case "gotoTab":
      chrome.tabs.getAllInWindow(tab.windowId, function(tabs) {
        if(msg.index) { var index = msg.index; }
        if(msg.offset){
          var index = tab.index + msg.offset;
          while(index > tabs.length){ index = index - tabs.length; }
          while(index < 0){ index = index + tabs.length; }
        }
        if(typeof index == 'undefined') index = tab.id;
        console.log("gotoTab:" + index + " index:" + msg.index + " offset:" + msg.offset);
        if(tabs[index]){ chrome.tabs.update(tabs[index].id, {selected: true}); }
      });
      break;
    case "lastSelectedTab":
      chrome.tabs.getAllInWindow(tab.windowId, function(tabs) {
        chrome.tabs.update(last_selected_tab.id, {selected: true});
      });
      break;
    case "reloadAllTabs":
      chrome.tabs.getAllInWindow(tab.windowId, function(tabs) {
        for (var i = 0; i < tabs.length; i++) {
          var jsRunner = {"code": "document.location.reload()"};
          chrome.tabs.executeScript(tabs[i].id, jsRunner);
        }
      });
      break;
    case "open_url":
      if (msg.newtab) { 
        chrome.tabs.create({url: msg.url, index: tab.index + 1});
        var myport = chrome.tabs.connect(tab.id, {});
        myport.postMessage({action: "remove_hints"});
      } else {
        chrome.tabs.update(tab.id, {url: msg.url});
      }
      break;
    case "storeLastCommand":
      localStorage.currentKeys = msg.currentKey.join(' ');
      localStorage.times       = msg.currentKey.join(' ');
      break;
    };
  });
});
</script>
</head>
</html>
