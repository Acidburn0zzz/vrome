<html>
<head>
<script typw='text/javascript'>
var closed_tabs = [];

chrome.extension.onConnect.addListener(function(port, name) {
  port.onMessage.addListener(function(msg) {
    var tab = port.tab;
    switch(msg.action){
    case "close_tab":
      closed_tabs.push({url: tab.url, index: tab.index});
      chrome.tabs.remove(tab.id);
      break;
    case "reopen_tab":
      if (closed_tabs.length > 0) {
        var last_closed_tab = closed_tabs[closed_tabs.length - 1]
        closed_tabs.pop();
        chrome.tabs.create({url: last_closed_tab.url, index: last_closed_tab.index});
      }
      break;
    case "previous_tab":
      chrome.tabs.getAllInWindow(tab.windowId, function(tabs) {
        var previous_tab = tabs[tab.index - 1] || tabs[tabs.length - 1];
        if (previous_tab) {
          chrome.tabs.update(previous_tab.id, {selected: true});
        }
      });
      break;
    case "next_tab":
      chrome.tabs.getAllInWindow(port.tab.windowId, function(tabs) {
        var next_tab = tabs[tab.index + 1] || tabs[0];
        if (next_tab) {
          chrome.tabs.update(next_tab.id, {selected: true});
        }
      });
      break;
    };
  });
});
</script>
</head>
</html>
